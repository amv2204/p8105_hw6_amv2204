---
title: "Homework 6"
author: "Ashwini Varghese"
date: "2022-12-03"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(mgcv)
library(modelr)
library(viridis)

knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  fig.width = 8,
  fig.asp = 1,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


## Problem 1



## Problem 2

We will start by loading the homicide data. 

```{r}
homicides = read.csv("./homicide-data.csv")
```

Next we will do some data cleaning as below:

```{r}
homicides =   
  homicides %>%
  unite("city_state", city:state, sep = ", ", remove = FALSE) %>% 
  mutate(solved = as.numeric(disposition == "Closed by arrest")) %>%
  filter(!(city %in% c("Dallas", "Phoenix", "Kansas City"))) %>%
  filter(city_state != "Tulsa, AL") %>%
  mutate(victim_age = as.numeric(victim_age)) %>%
  filter(victim_race %in% c("White", "Black")) %>%
  mutate(victim_race = fct_relevel(victim_race, "White")) %>%
  filter(victim_sex != "Unknown")

homicides %>% 
  group_by(city_state) %>%
  summarize() %>% 
  print(n = 51)

homicides %>% 
  group_by(victim_race) %>%
  summarise() 
  
```

Now for just the city of Baltimore, we will fit a logistic model with homicide being solved as the outcome and with victim age, sex, and race as predictors. 

```{r}

Balt =
  homicides %>%
  filter(city == "Baltimore") %>%
  select(solved, victim_age, victim_race, victim_sex)

fit_balt = 
  Balt %>% 
  glm(solved ~ victim_age + victim_race + victim_sex, data = ., family = binomial()) 

fit_balt %>% 
  broom::tidy() %>%
  mutate(lower_CI = exp(estimate - 1.96*std.error),
         upper_CI = exp(estimate + 1.96*std.error),
         OR = exp(estimate)) %>%
  select(term, OR, lower_CI, upper_CI) %>% 
  knitr::kable(digits = 3)


```

Let's repeat this for all the cities and get the OR with their 95% CI for solving homicides comparing males to females, adjusting for race and age.  

```{r}
homi_nest =
  homicides %>% 
  select(city_state, solved, victim_age, victim_race, victim_sex) %>% 
  relocate(city_state) %>% 
  nest(data = solved:victim_sex)


fit_all = 
  homi_nest %>% 
  mutate(
    models = map(.x = data, ~glm(solved ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
    results = map(models, broom::tidy)) %>% 
  select(-data, -models) %>% 
  unnest(results) %>% 
  mutate(lower_CI = exp(estimate - 1.96*std.error),
         upper_CI = exp(estimate + 1.96*std.error),
         OR = exp(estimate)) %>%
  select(city_state, term, OR, lower_CI, upper_CI) %>%
  filter(term == "victim_sexMale")

fit_all %>%
  knitr::kable(digits = 3)

```

Now we will make a plot showing the OR and 95% CI for each city.

```{r}

fit_all %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) +        
    geom_point() +
    geom_errorbar(aes(ymin = lower_CI, ymax = upper_CI)) +
    theme(axis.text.x = element_text(angle = 80, hjust = 1))

```

From this plot, we can see the city with the lowest OR for solved homicides comparing male victims to females while adjusting for race and age is New York at 0.26 and the highest is Albuquerque at 1.77.

The interpretations are as follows: 

In New York City, the odds of solving a homicide case for a male is 0.26 times the odds of solving a homicide case for a female, adjusting for race and age. In Albuquerque, the odds of solving a homicide case for a male is 1.77 times the odds of solving a homicide case for a female, adjusting for race and age.

However, the confidence interval for Albuquerque includes the null value of 1 making the OR not statistically significant whereas 1 is not in the confidence interval for New York, which means the OR is statistically significant. We would need to double check with the p-values.


